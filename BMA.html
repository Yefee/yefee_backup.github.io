<!DOCTYPE html>



  



<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


<html class="theme-next mist use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="nFL6dDoVd9NFtyL3BrZ7iiTtmyDFX3WQ9qPE0utAgJ8" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content=",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,," />










<meta name="description" content="How warm the future will be and how certain we areThe ongoing warming is a well-accepted feature of the near future climate change, however how warm it will be and how certain we are remain debatable">
<meta name="keywords" content="python, time series, prediction">
<meta property="og:type" content="website">
<meta property="og:title" content="BMA">
<meta property="og:url" content="https://github.com/Yefee/yefee.github.io/BMA.html">
<meta property="og:site_name" content="Chengfei He">
<meta property="og:description" content="How warm the future will be and how certain we areThe ongoing warming is a well-accepted feature of the near future climate change, however how warm it will be and how certain we are remain debatable">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-12-19T03:43:22.222Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BMA">
<meta name="twitter:description" content="How warm the future will be and how certain we areThe ongoing warming is a well-accepted feature of the near future climate change, however how warm it will be and how certain we are remain debatable">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/Yefee/yefee.github.io/BMA.html"/>





  <title>BMA | Chengfei He</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111643061-1', 'auto');
  ga('send', 'pageview');
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chengfei He</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">His blog and something interesting</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-publications">
          <a href="/Publications/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-Publications"></i> <br />
            
            Publications
          </a>
        </li>
      
        
        <li class="menu-item menu-item-github">
          <a href="https://github.com/Yefee" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Github
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
    
    <div class="post-block page">
      <header class="post-header">

	<h1 class="post-title" itemprop="name headline">BMA</h1>



</header>

      
      
      
      <div class="post-body">
        
        
          
<h1 id="How-warm-the-future-will-be-and-how-certain-we-are"><a href="#How-warm-the-future-will-be-and-how-certain-we-are" class="headerlink" title="How warm the future will be and how certain we are"></a>How warm the future will be and how certain we are</h1><p>The ongoing warming is a well-accepted feature of the near future climate change, however how warm it will be and how certain we are remain debatable and unclear, even though significant progress has been made in qualifying the increase in the temperature by averaging an bunch of start-of-the-art climate models (e.g. the <a href="https://esgf-node.llnl.gov/projects/cmip5/" target="_blank" rel="noopener">CMIP5</a>) or an ensemble of member forecasts from a single model (e.g. <a href="http://www.cesm.ucar.edu/projects/community-projects/LENS/" target="_blank" rel="noopener">CESM-LEN</a>). Here I provide modeling evidence that reveals the increase in temperature and its uncertainty based on Bayesian Inference. Basically,  members from an ensemble model prediction is exxtracted randomly, then they are regressed on historical observation data using Bayesian linear regression. Finally these Bayesian models are averaged by stacking the predictive distributions. The results show that the stacking model can largely remove the error in the testing period and predict that the global mean surface air temperature at the end of this century is about 3 oC warmer in RCP8.5 scenario, not as intense as that of the ensemble mean, which warms about 4 oC. The warming mostly occurs at high latitudes but with large certainty which shall be taken into serious consideration by policy makers. </p>
<p>Simple inline $ a = b + c $.</p>
<h1 id="Methodology"><a href="#Methodology" class="headerlink" title="Methodology"></a>Methodology</h1><p>The BMA method for calibrating forecast ensembles was first introduced by Raftery et al (2008). The BMA predictive PDF of a future weather quantity $x$ is the weighted sum of individual PDFs corresponding to the ensemble members.</p>
<p>$$p \left(x|F_1,…,F<em>M \right)<br>= \sum</em>{k=1}^{M}{w<em>{k}g</em>{k}(x|F_k)}$$</p>
<p>where $g_k (x│F_k )$ can be interpreted as the conditional PDF of $x$ conditional on the forecast $F_k$ and weight $w_k$ is the probability of ensemble member k being the best and is based on forecast $F<em>k$ s performance in the training period. The weights form a probability distribution such that  $\sum{</em>{k=1}^{M}w_k} = 1$ and $w_k≥0$. Generally, the annual mean temperature follows the Gaussian distribution centered at a linear function of the forecasts in the ensemble $μ_k$, hence the probabilistic notation of forecast $F_k$ is<br>$$F_k | (f_1, …,f_k) ~ N(\mui_k, \sigma_k^2)$$ </p>
<p>with the mean given by </p>
<p>$$ \mui_k = \beta<em>0 + \sum</em>{i=1}^{k}{\beta_i f_i}$$</p>
<p>in which $(f_1,…,f<em>k)$ denotes $k$ forecast members picked up from the ensemble set of size $K$, so that in total we would have a number of  $$\sum</em>{i=1}^{K}(i K)$$forecasts. For example, if we have an ensemble of 3 members, we can produce ∑_i^3▒(■(i@3)) =7 forecasts from this ensemble. Previously, people infer the forecast PDF g_k (x│f_k ) based on single member f_k alone which may distort the BMA production due to the chaos of the climate system. Here, I randomly combine a subset of the ensemble members, eventually building a super ensemble of single models (supBMA), which benefits the model generalization ability in the production. </p>
<p>The Markov chain Monte Carlo6 (MCMC) is used to estimate the parameters of βs and σs. The MCMC sampler draws parameter values from the prior distribution and computes the likelihood that the observed data comes from a distribution with these parameter values.<br>p(β│Data)∝ p(Data┤|β)*p(β)<br>This calculation acts as a guiding light for the MCMC sampler. As it draws values from the parameter priors, it computes the likelihood of these parameters given the data, and tries to guide the sampler towards areas of higher probability.</p>
<p>Finally, the weights w<em>k are calculated by stacking of predictive distributions, in which several models are combined into a meta-model in order to minimize the diverge between the meta-model and the true generating model as suggested by Yao et al.7, when using a logarithmic score this is equivalently to:<br>max┬w⁡〖1/n ∑</em>(i=1)^n▒〖log∑_(k=1)^M▒〖w_k g_k (y<em>i |y</em>(-i),M<em>k)〗〗〗  s.t.∑</em>(k=1)^M▒w_k =1, w_k≥0<br>where the quantity g_k (y<em>i |y</em>(-i),M_k) is the leave-one-out predictive distribution for the M_k model.</p>
<h1 id="Case-1-Lorenz-63-toy-model"><a href="#Case-1-Lorenz-63-toy-model" class="headerlink" title="Case 1: Lorenz 63 toy model"></a>Case 1: Lorenz 63 toy model</h1><p>I first examine my model using a low-order spectral model based on Lorenz (1963), in which parameters are set for the models as suggested by Krishnamurti et al.8. The system is<br>described by the equations below:<br>X ̇= -σX+σY+f cos⁡θ<br>Y ̇= -XZ+rX-Y+f sin⁡θ<br>Z ̇= -XY-bZ<br>in which X, Y, and Z are the time-dependent spectral amplitudes, the dot on the top of them denotes time derivative. Assignment of different values for these parameters (σ,θ,r,b) enable us to construct an ensemble of models as shown in table 1. The initial values of X, Y, and Z are 0, 10, and 0 respectively.</p>
<p>Table 1. Toy model parameters<br>| parameters     | Control run | Multimodel parameters    |<br>| :—           |    :—-:   |          —: |<br>| σ              | 40.0        | 20.0-50.0     |<br>| θ              | 45o         | 42.3o-46.8o      |<br>| r              | 24.74       | 22.7-28.1      |<br>| b              | 4.74        | 4.9-6.0      |</p>
<p>This toy numerical model that can be integrated forward in time and the variation of model parameters in Table 1 can be thought of a set of model ensembles which use different physical parameterizations. The model outputs from the toy model and the supBMA prediction are shown in Figure 1a-c. The time from 0 to 150 is used for training and thereafter, all supBMA model parameters are kept as constant for the prediction in 151-200. The thick black line indicates the control run and the thin grey lines represent the ensemble of our parameter-perturbed individual model runs. It is expected that the individual models are of large error since their solutions carry large phase mismatch. All blue lines are forecasts F_k from the single Bayesian linear regression model, which has ∑_i^5▒(■(i@5)) = realizations in this case. As demonstrated by the three variable predictions, the BLR forecast reduces the error significantly compared to the individual model forecasts, especially in the first two variable forecasts. Finally, the red line indicates the supBMA prediction, with the semi-transparent shading area as the 95% confidence interval. It is shown that the supBMA is the best solution closest to the control run. Figure 1d-f shows the predictive PDF for BLR models F_k and predictions of member models f_k at time 160. The grey dots are single predictions with large spread, and the blue curves are PDF for BMA models. The red curve is PDF for supBMA model which shows small variance, and the average of the model is close to the control run represented by the vertical black line.</p>

<p>Figure 1. The toy model predictions and the forecasts by BLR and supBMA. a-c, the control toy model prediction (black), parameter-perturbed individual model runs (grey), BLR forecasts (blue) and supBMA forecasts (red). The red interval in a-c indicates the 95% confidence interval of the supBMA prediction. d-f, the PDF of BLR (blue) and supBMA (red) predictions at time 160. The member model predictions are indicated by grey dots and the expectation of the supBMA is represented by the vertical red line with control run as the vertical black line.</p>
<h1 id="Case-2-Prediction-of-SAT-at-the-end-of-the-21st-century"><a href="#Case-2-Prediction-of-SAT-at-the-end-of-the-21st-century" class="headerlink" title="Case 2: Prediction of SAT at the end of the 21st century"></a>Case 2: Prediction of SAT at the end of the 21st century</h1><p>In this case, I implement our supBMA model to the global SAT prediction in the 21st century. Here 8 members are randomly selected from the Community Earth System Model (CESM) large ensemble simulations provided by the CESM community. The CESM uses a nominal ~1-degree resolution globally with diagnostic biogeochemistry calculations for the ocean ecosystem and an active atmospheric carbon dioxide cycle9. Each ensemble runs from 1920 to 2100 using historical forcing (1920–2005) and Representative Concentration Pathway 85 (RCP 8.5) in 2006 to 2100, but with slightly different initial conditions. The 20th century reanalysis from National Oceanic and Atmospheric Administration is used as observation. The reanalysis covers data from 1851 to 2014, so the data from 1920 to 2014 is employed to train and test my model.<br><br>Figure 2. Global mean SAT time series. The observation data covers from 1920-2014 (blue). The eight ensemble members are in grey, with the ensemble mean as red. The supBMA prediction is in green, and the error bars on supBMA shows the 90% confidence interval of the prediction.</p>
<p>Figure 2 shows the global mean SAT from 1920s to 2100. During the training period within 1920 to 2007, the global mean SAT increases by more than 0.5 oC (blue, observation). The ensemble average of CESM (red) shows consistent response with the observations in the training period, however, the ensemble average simulation warms more strongly and rapidly than the observation during the test period (2008-2014). The same error can also be seen from Figure 3b, in which the time mean spatial errors of ensemble average simulation during 2008 to 2014 are shown. Interestingly, the ensemble average simulates a cooler climate at high latitudes but a warmer one in low latitudes mainly dominated by the response over ocean, indicating the SAT polar amplification  is much more intensive in the real world than that in the model simulations.  Back to the supBMA prediction, the error in ensemble members is greatly removed globally in Figure 3a. Consistently, the global mean SAT by supBMA (green) in Figure 1 is much closer to the observation (blue) in testing period than the widely used ensemble mean. </p>

<p>Figure 3. Time mean error of supBMA and ensemble mean simulations in the testing period (2008-2014). a, supBMA. b, ensemble mean.</p>
<p>Finally, I freeze the parameters in supBMA and apply them to the future prediction from 2015 to 2100 (I don’t have 2015-2018 observation, so here I count them as future prediction). Compared to the ensemble average with really small standard deviation as indicated by the spread of single members, the prediction from supBMA shows less increase in global mean SAT (Figure 2). However, the uncertainty measured by the 90% confidence interval at the end of 21st century amplifies compared to that in the training period as expected.</p>

<p>Figure 4. Temperature responses at the last decade of the 21st century (2191-2100) predicted by supBMA. The dot hatching area indicates uncertainty of warming is below 2 oC, and the dash hatching area indicates uncertainty is more than 5 oC. The uncertainty is defined as the 90% confidence interval of the supBMA prediction.</p>
<p>Figure 4 shows the spatial warming responses at the last decade of 21st century (2191-2100).  The intense warming mostly occurs at high latitudes in the northern hemisphere with small uncertainty which is physically reasonable because the reduction in sea ice coverage reduces the local planet albedo and in turn the surface absorbs more short-wave radiation, eventually leading larger warming there. Other areas like west America and Sahara in Africa are also exposed into large warming danger that will bring more intensive disasters in the future. Another interesting issue need to be addressed here is that we observe cooling happens over the Southern Ocean, poleward of the Antarctic Circumpolar Current, whereas global mean SAT increases more than 3oC until the end of this century. This issue is of large certainty in my supBMA model prediction, and is also found in many other GCM simulations, but remains debatable10. Globally, most of the areas are of small uncertainty that the warming/cooling predicted by the supBMA model will happen within less than 2 oC error, especially areas at high latitudes. The most uncertain warming actually comes from the ocean surface and the Antarctic continent.</p>
<h1 id="Discussion"><a href="#Discussion" class="headerlink" title="Discussion"></a>Discussion</h1><p>In summary, a Bayesian statistical model is built in my current work to predict the temperature at the end of this century based on an ensemble forecast from the climate model called CESM.  After training the Bayesian on the historical data, the model significantly reduces the error in the testing data compared to the ensemble mean. Finally, the model is applied to predict temperature from 2015 to 2100 and I find the Bayesian model show less temperature increase than the ensemble mean which is a good news! However, significant warming is found at highlatitudes in north hemisphere with less uncertainty which is physically reasonable. This warming shall be taken into serious consideration by the people there and policy makers to avoid the fatal disaster it will cause.<br>Future work can be done by extending this simple model to predict rainfall. Since the rainfall is not Gaussian distributed, the task won’t be not as easy as to predict temperature. Generally, daily rainfall follows a mixed gamma distribution, which has two peaks with one peak at zero (because most day has no rainfall), and the other at somewhere larger than zero. Fitting data in this distribution will cause much more computations.</p>

        
      </div>
      
      
      
    </div>
    
    
    
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/gs6.gif"
                alt="Chengfei He" />
            
              <p class="site-author-name" itemprop="name">Chengfei He</p>
              <p class="site-description motion-element" itemprop="description">Geek</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yefee" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.linkedin.com/in/chengfei-he-320099135/" target="_blank" title="LinkedIn">
                    
                      <i class="fa fa-fw fa-linkedin"></i>LinkedIn</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
              </a>
            </div>
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#How-warm-the-future-will-be-and-how-certain-we-are"><span class="nav-number">1.</span> <span class="nav-text">How warm the future will be and how certain we are</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Methodology"><span class="nav-number">2.</span> <span class="nav-text">Methodology</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Case-1-Lorenz-63-toy-model"><span class="nav-number">3.</span> <span class="nav-text">Case 1: Lorenz 63 toy model</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Case-2-Prediction-of-SAT-at-the-end-of-the-21st-century"><span class="nav-number">4.</span> <span class="nav-text">Case 2: Prediction of SAT at the end of the 21st century</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Discussion"><span class="nav-number">5.</span> <span class="nav-text">Discussion</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengfei He</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
  View:<span id="busuanzi_value_site_pv"></span>
</span>
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://https-yefee-github-io.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://github.com/Yefee/yefee.github.io/BMA.html';
          this.page.identifier = 'BMA.html';
          this.page.title = 'BMA';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://https-yefee-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  









<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
        <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitment({
            id: window.location.pathname, 
            owner: 'yefee90@gmail.com',
            repo: 'https://github.com/Yefee/yefee.github.io.git',
            
            oauth: {
            
            
                client_secret: '0f53a3a44ac322e289ff87a9e527e7c4106931f4',
            
                client_id: '1a0317a74d7c097885ef'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  

  
  


  

  

</body>
</html>
